name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  prepare-assets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate Icons
        run: |
          # Convert SVG to PNG (512x512)
          convert -background none -resize 512x512 .github/assets/logo.svg logo.png
          
          # Convert SVG to ICO (containing multiple sizes)
          convert -background none .github/assets/logo.svg -define icon:auto-resize=256,128,64,48,32,16 logo.ico

      - name: Upload Icons
        uses: actions/upload-artifact@v4
        with:
          name: icons
          path: |
            logo.png
            logo.ico

  build-windows:
    needs: prepare-assets
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Icons
        uses: actions/download-artifact@v4
        with:
          name: icons
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Build Frontend
        run: |
          npm ci
          npm run build
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download Python Embedded
        run: |
          $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
          New-Item -ItemType Directory -Path "build\python-embed" -Force
          Invoke-WebRequest -Uri $pythonUrl -OutFile "build\python-embed.zip"
          Expand-Archive -Path "build\python-embed.zip" -DestinationPath "build\python-embed" -Force
          Remove-Item "build\python-embed.zip"
          
          # Enable pip
          $pthFile = Get-ChildItem -Path "build\python-embed" -Filter "*._pth" | Select-Object -First 1
          $content = Get-Content $pthFile.FullName
          $content = $content -replace '#import site', 'import site'
          Set-Content $pthFile.FullName $content
          
          # Install pip
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "build\python-embed\get-pip.py"
          & "build\python-embed\python.exe" "build\python-embed\get-pip.py"
          Remove-Item "build\python-embed\get-pip.py"
        shell: pwsh
      
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: pwsh
      
      - name: Copy Launcher Files
        run: |
          Copy-Item "installer\WL-Drop-Launcher.bat" -Destination "."
          Copy-Item "installer\WL-Drop.vbs" -Destination "."
        shell: pwsh
      
      - name: Build Installer
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer\wl-drop-setup.iss"
        shell: pwsh
          
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: release/wl-drop-v*-windows-setup.exe

  build-linux:
    needs: prepare-assets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Icons
        uses: actions/download-artifact@v4
        with:
          name: icons
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Build Frontend
        run: |
          npm ci
          npm run build
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Prepare Build
        run: |
          mkdir -p uploads
          
      - name: Build Binary
        run: |
          pyinstaller wl-drop.spec --distpath build_artifacts
          
      - name: Create Debian Package
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          mkdir -p package/usr/bin
          mkdir -p package/usr/share/applications
          mkdir -p package/usr/share/icons/hicolor/512x512/apps
          mkdir -p package/DEBIAN
          
          # Copy Binary
          cp build_artifacts/wl-drop package/usr/bin/
          chmod 755 package/usr/bin/wl-drop
          
          # Copy Icon
          cp logo.png package/usr/share/icons/hicolor/512x512/apps/wl-drop.png
          
          # Copy Desktop File
          cp build_tools/linux/wl-drop.desktop package/usr/share/applications/
          
          # Process Control File
          sed "s/{{VERSION}}/$VERSION/" build_tools/linux/control > package/DEBIAN/control
          
          # Build .deb
          dpkg-deb --build package wl-drop-linux-amd64.deb
          
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: wl-drop-linux-amd64.deb
